import strawberry
import datetime
from typing import Optional, List


from .main import (
    list_tables,
    get_all_students,
    get_student_by_id,
    get_groups,
    get_all_events,
    create_event,
    get_event_data,
    check_in,
    check_out,
    live_attendance,
    finalize_event,
)


# GraphQL Types


@strawberry.type
class Guardian:
    guardianID: int
    firstName: str
    lastName: str
    phoneNumber: Optional[str]
    email: Optional[str]


@strawberry.type
class SmallGroup:
    groupID: int
    name: Optional[str]
    members: List["Student"]


@strawberry.type
class Event:
    eventID: int
    name: Optional[str]
    location: str
    date: datetime.date
    time: str
    customFields: Optional[dict] = None


@strawberry.type
class Student:
    studentID: int
    firstName: str
    lastName: str
    age: int
    phoneNumber: Optional[str]
    email: Optional[str]
    groupID: int
    guardians: List[str]


# Response Types


@strawberry.type
class RootMessage:
    message: str
    tables: List[str]


@strawberry.type
class EventResponse:
    message: str
    eventID: int
    customFields: Optional[dict]


@strawberry.type
class CheckInResponse:
    message: str
    eventID: int
    studentID: int


@strawberry.type
class CheckOutResponse:
    message: str
    eventID: int
    studentID: int


@strawberry.type
class LiveAttendanceResponse:
    eventID: int
    checkedIn: List[int]
    count: int


@strawberry.type
class FinalizeEventResponse:
    message: str
    eventID: int
    registeredSaved: List[int]
    walkInsLogged: List[int]
    totalRegistered: int
    totalWalkIns: int
    totalAttendees: int


# Query Resolvers


@strawberry.type
class Query:

    @strawberry.field
    def root(self) -> RootMessage:
        return RootMessage(
            message="Welcome to the Youth Group API!",
            tables=list_tables()
        )

    @strawberry.field
    def students(self) -> List[Student]:
        return get_all_students()

    @strawberry.field
    def student(self, student_id: int) -> Optional[Student]:
        return get_student_by_id(student_id)

    @strawberry.field
    def groups(self) -> List[SmallGroup]:
        return get_groups()

    @strawberry.field
    def events(self) -> List[Event]:
        return get_all_events()

    @strawberry.field
    def event(self, event_id: int) -> Optional[Event]:
        return get_event_data(event_id)

    @strawberry.field
    def liveAttendance(self, event_id: int) -> LiveAttendanceResponse:
        return live_attendance(event_id)


# Mutation Resolvers


@strawberry.type
class Mutation:

    @strawberry.mutation
    def createEvent(self, name: str, location: str, date: str, time: str,
                    customFields: Optional[dict] = None) -> EventResponse:
        data = {"name": name, "location": location, "date": date, "time": time,
                "customFields": customFields or {}}
        return create_event(data)

    @strawberry.mutation
    def checkIn(self, event_id: int, student_id: int) -> CheckInResponse:
        return check_in(event_id, student_id)

    @strawberry.mutation
    def checkOut(self, event_id: int, student_id: int) -> CheckOutResponse:
        return check_out(event_id, student_id)

    @strawberry.mutation
    def finalizeEvent(self, event_id: int) -> FinalizeEventResponse:
        return finalize_event(event_id)


# Build Schema

schema = strawberry.Schema(query=Query, mutation=Mutation)
